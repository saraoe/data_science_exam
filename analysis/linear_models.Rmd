# Linear models 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# install.packages('pacman')
library(pacman)
pacman::p_load(
    tidyverse, 
    lmerTest,
    patchwork
)

```

## Data
```{r}
df <- read_csv("data/model_df.csv") %>% 
        mutate(change_point = change_point + 1,  # making the first changepoint 1 instead of 0
               event = ifelse(epidemiological==1 | policy==1 | other==1, 1, 0),
               # z-score scaling
               zresonance = scale(resonance),
               znovelty = scale(novelty),
               zhappiness = scale(happiness), 
               ztrust = scale(trust),
               zexpectation = scale(expectation),
               zsurprised = scale(surprised),
               zanger = scale(anger),
               zcontempt = scale(contempt), 
               zgrief = scale(grief), 
               zfear = scale(fear)
               )  
```

## Explore and Visualize
```{r}
df %>% group_by(change_point) %>%
    summarize(n(), mean(resonance), sd(resonance), max(date), min(date))
```

```{r}
ggplot(data = df, aes(x = happiness, y = resonance)) + 
    geom_point() +
    geom_smooth(method = lm) + 
    facet_wrap(.~change_point)
```

```{r}
ggplot(data = df, aes(x = novelty, y = resonance)) + 
    geom_point(alpha=0.5) +
    geom_smooth(method = lm, color='firebrick') + 
    facet_wrap(.~change_point) + 
    theme_light()
```

```{r}
for (n in unique(df$change_point)){
    df_changepoint <- df %>% filter(change_point==n)
    tmp_p <- ggplot(data = df_changepoint, aes(x = novelty, y = resonance)) + 
        geom_point(alpha=0.5) +
        geom_smooth(method = lm, color='steelblue') +  
        theme_light() + labs(title = n)
    eval(parse(text=paste('p_', n, ' <- tmp_p', sep='')))
}

(p_1 + p_2) / (p_3 + p_4)
```

```{r}
qs = c(0.03, 0.25, 0.5, 0.75, 0.97)

df2 <- df %>% group_by(change_point) %>%
    summarize(
              res_q = quantile(resonance, qs), 
              q = qs
              )

df2_lower <- df2 %>% filter(q == min(qs))
df2_upper <- df2 %>% filter(q == max(qs))

df2 <- data.frame(
    change_point = df2_lower$change_point,
    res_lower = df2_lower$res_q,
    res_upper = df2_upper$res_q
)

ggplot(data = df) + 
    geom_density(aes(x = resonance), color='steelblue') +
    # geom_vline(data = df2_lower, mapping = aes(xintercept = res_q),
    #            linetype = "longdash", alpha = 0.5) + 
    # geom_vline(data = df2_upper, mapping = aes(xintercept = res_q),
    #            linetype = "longdash", alpha = 0.5) + 
    geom_text(data=df2_lower, mapping=aes(x=res_q, label=paste(round(res_q, 3)), y=50),  
                                #  angle=90, 
                                hjust = 'outward'
                                ) +
    geom_text(data=df2_upper, mapping=aes(x=res_q, label=paste(round(res_q, 3)), y=50),  
                                #  angle=90, 
                                hjust = 'outward'
                                ) +
    geom_segment(data = df2, mapping = aes(x=res_lower,xend=res_upper,y=0,yend=0), size=0.7) +
    facet_wrap(.~change_point) + 
    labs(y='Density', x = 'Resonance') +
    theme_bw() + theme(strip.background =element_rect(fill="white"))
```

## Models

### Resonance Novelty slope
```{r}
model <- lm(zresonance ~ znovelty, data=df)

print(summary(model))
```

```{r}
for (n in unique(df$change_point)){
    print(paste('CHANGE POINT =', n))
    df_changepoint <- df %>% filter(change_point==n)

    model <- lm(zresonance ~ znovelty, data=df_changepoint)

    print(summary(model))
}
```

### Emotions
resonance ~ all emotions
```{r}
model <- lm(resonance ~ happiness + 
                        trust + 
                        expectation + 
                        surprised +
                        anger +
                        contempt +
                        grief +
                        fear, data=df)

print(summary(model))
```

```{r}
model <- lm(zresonance ~ zhappiness + 
                        ztrust + 
                        zexpectation + 
                        zsurprised +
                        zanger +
                        zcontempt +
                        zgrief +
                        zfear, data=df)

print(summary(model))
```

```{r}
for (n in unique(df$change_point)){
    print(paste('CHANGE POINT =', n))
    df_changepoint <- df %>% filter(change_point==n)

    model <- lm(resonance ~ happiness + 
                            trust + 
                            expectation + 
                            surprised +
                            anger +
                            contempt +
                            grief +
                            fear, data=df_changepoint)

    print(summary(model))
}
```

resonance ~ happiness + expectation
```{r}
model <- lm(resonance ~ happiness + expectation, data=df)

print(summary(model))
```

```{r}
for (n in unique(df$change_point)){
    print(paste('CHANGE POINT =', n))
    df_changepoint <- df %>% filter(change_point==n)

    model <- lm(resonance ~ happiness + expectation, data=df_changepoint)

    print(summary(model))
}
```

```{r}
for (n in unique(df$change_point)){
    print(paste('CHANGE POINT =', n))
    df_changepoint <- df %>% filter(change_point==n)

    model <- lm(zresonance ~ zhappiness + zexpectation, data=df_changepoint)

    print(summary(model))
}
```

### Covid events

Events from the SSI timeline
```{r}
model <- lm(resonance ~ epidemiological + policy + other, data=df)

print(summary(model))
```

```{r}
for (n in unique(df$change_point)){
    if (n == 1) next  # skip first changepoint
    print(paste('CHANGE POINT =', n))
    df_changepoint <- df %>% filter(change_point==n)

    model <- lm(zresonance ~ epidemiological + policy + other, data=df_changepoint)

    print(summary(model))
}
```

```{r}
for (n in unique(df$change_point)){
    if (n == 1) next  # skip first changepoint
    print(paste('CHANGE POINT =', n))
    df_changepoint <- df %>% filter(change_point==n)

    model <- lm(zresonance ~ event, data=df_changepoint)

    print(summary(model))
}
```

Number of new cases
```{r}
model <- lm(resonance ~ new_cases_MA7, data=df)

print(summary(model))
```

```{r}
for (n in unique(df$change_point)){
    if (n == 1) next  # skip first changepoint
    print(paste('CHANGE POINT =', n))
    df_changepoint <- df %>% filter(change_point==n)

    model <- lm(zresonance ~ new_cases_MA7, data=df_changepoint)

    print(summary(model))
}
```
